generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "rhel-openssl-1.0.x", "linux-musl"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String           @id
  email            String           @unique
  displayName      String?          @map("display_name")
  avatarUrl        String?          @map("avatar_url")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  stripeCustomerId String?          @unique @map("stripe_customer_id")
  activities       Activity[]
  boardActivities  BoardActivity[]  @relation("BoardActivityUser")
  clientsCreated   Client[]         @relation("UserClients")
  issuedInvoices   Invoice[]        @relation("IssuedBy")
  issueComments    IssueComment[]   @relation("IssueCommentAuthor")
  assignedIssues   Issue[]          @relation("IssueAssignee")
  createdIssues    Issue[]          @relation("IssueCreator")
  subscription     Subscription?    @relation("UserSubscription")
  taskActivities   TaskActivity[]   @relation("TaskActivityUser")
  taskAttachments  TaskAttachment[] @relation("TaskAttachmentUploader")
  taskComments     TaskComment[]    @relation("TaskCommentAuthor")
  assignedTasks    Task[]           @relation("TaskAssignee")
  createdTasks     Task[]           @relation("TaskCreator")
  invites          TeamInvite[]     @relation("InvitedBy")
  teamMembers      TeamMember[]
  ownedTeams       Team[]           @relation("TeamOwner")
  paymentSettings  PaymentSettings? @relation("UserPaymentSettings")

  @@index([createdAt(sort: Desc)], map: "idx_users_created_at_desc")
  @@index([email], map: "idx_users_email")
  @@map("users")
}

model Subscription {
  id               String   @id @default(cuid())
  userId           String   @unique @map("user_id")
  stripePriceId    String   @map("stripe_price_id")
  stripeSubId      String   @map("stripe_subscription_id")
  currentPeriodEnd DateTime @map("current_period_end")
  status           String
  createdAt        DateTime @default(now()) @map("created_at")
  user             User     @relation("UserSubscription", fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Client {
  id            String       @id @default(cuid())
  name          String
  email         String
  phone         String?
  company       String?
  address       String?
  notes         String?
  budget        Float?       // Added budget field for client budget management
  currency      String?      // Added currency field for client budget
  status        ClientStatus @default(PROSPECT)
  createdBy     String       @map("created_by")
  createdAt     DateTime     @default(now()) @map("created_at")
  createdByUser User         @relation("UserClients", fields: [createdBy], references: [id], onDelete: Cascade)
  invoices      Invoice[]
  projects      Project[]    @relation("ClientProjects")
  proposals     Proposal[]   @relation("ClientProposals")
  estimations   Estimation[] @relation("ClientEstimations")
  updates       UpdateDraft[] @relation("ClientUpdates")

  @@index([createdAt(sort: Desc)], map: "idx_clients_created_at_desc")
  @@index([createdBy], map: "idx_clients_created_by")
  @@map("clients")
}

model Invoice {
  id                String             @id @default(cuid())
  invoiceNumber     String             @unique
  clientId          String             @map("client_id")
  issuedById        String             @map("issued_by_id")
  dueDate           DateTime           @map("due_date")
  issuedDate        DateTime           @default(now()) @map("issued_date")
  status            InvoiceStatus      @default(PENDING)
  paymentMethod     PaymentMethod?
  notes             String?
  taxRate           Float?             @map("tax_rate")
  discount          Float?             @default(0)
  currency          String             @default("INR")
  pdfUrl            String?            @map("pdf_url")
  isRecurring       Boolean            @default(false) @map("is_recurring")
  recurrence        InvoiceRecurrence?
  nextIssueDate     DateTime?          @map("next_issue_date")
  lastSentDate      DateTime?          @map("last_sent_date")
  reminderSent      Boolean            @default(false) @map("reminder_sent")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  enablePaymentLink Boolean            @default(false) @map("enable_payment_link")
  eSignatureUrl     String?            @map("e_signature_url")
  watermarkText     String?            @map("watermark_text")
  // Razorpay payment link fields
  razorpayPaymentLinkId String?        @map("razorpay_payment_link_id")
  razorpayPaymentLinkUrl String?       @map("razorpay_payment_link_url")
  razorpayPaymentLinkStatus String?    @map("razorpay_payment_link_status")
  razorpayPaymentId String?            @map("razorpay_payment_id")
  razorpayOrderId   String?            @map("razorpay_order_id")
  items             InvoiceItem[]
  client            Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  issuedBy          User               @relation("IssuedBy", fields: [issuedById], references: [id])

  @@index([clientId], map: "idx_invoices_client_id")
  @@index([clientId, status, dueDate], map: "idx_invoices_client_status")
  @@index([dueDate], map: "idx_invoices_due_date")
  @@index([issuedById], map: "idx_invoices_issued_by_id")
  @@index([issuedDate], map: "idx_invoices_issued_date")
  @@index([status], map: "idx_invoices_status")
  @@index([issuedById, status, issuedDate(sort: Desc)], map: "idx_invoices_user_status")
  @@index([razorpayPaymentLinkId], map: "idx_invoices_razorpay_link_id")
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String   @map("invoice_id")
  description String
  quantity    Int
  rate        Float
  total       Float    @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId], map: "idx_invoice_items_invoice_id")
  @@map("invoice_items")
}

model Team {
  id          String       @id @default(cuid())
  name        String
  description String?
  createdBy   String       @map("created_by")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  activities  Activity[]
  boards      Board[]
  projects    Project[]    @relation("TeamProjects")
  invites     TeamInvite[]
  members     TeamMember[]
  owner       User         @relation("TeamOwner", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)], map: "idx_teams_created_at_desc")
  @@index([createdBy], map: "idx_teams_created_by")
  @@map("teams")
}

model TeamMember {
  id         String   @id @default(cuid())
  teamId     String   @map("team_id")
  userId     String   @map("user_id")
  role       String   @default("member")
  addedBy    String   @map("added_by")
  acceptedAt DateTime @default(now()) @map("accepted_at")
  createdAt  DateTime @default(now()) @map("created_at")
  team       Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId, role], map: "idx_team_members_role")
  @@index([teamId], map: "idx_team_members_team_id")
  @@index([userId], map: "idx_team_members_user_id")
  @@map("team_members")
}

model TeamInvite {
  id        String    @id @default(cuid())
  teamId    String    @map("team_id")
  email     String
  role      String    @default("member")
  token     String    @unique
  invitedBy String    @map("invited_by")
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  inviter   User      @relation("InvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email])
  @@index([email], map: "idx_team_invites_email")
  @@index([teamId], map: "idx_team_invites_team_id")
  @@index([token], map: "idx_team_invites_token")
  @@map("team_invites")
}

model Activity {
  id        String   @id @default(cuid())
  teamId    String   @map("team_id")
  userId    String   @map("user_id")
  type      String
  title     String
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)], map: "idx_activities_created_at")
  @@index([userId], map: "idx_activities_user_id")
  @@index([userId, createdAt(sort: Desc)], map: "idx_activities_user_recent")
  @@map("activities")
}

model Board {
  id          String          @id @default(cuid())
  name        String
  type        BoardType       @default(KANBAN)
  teamId      String          @map("team_id")
  createdBy   String          @map("created_by")
  settings    Json?
  position    Int             @default(0)
  archived    Boolean         @default(false)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  projectId   String?         @map("project_id")
  description String?
  activities  BoardActivity[]
  lists       BoardList[]
  project     Project?        @relation("ProjectBoards", fields: [projectId], references: [id])
  team        Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  issues      Issue[]         @relation("BoardIssues")
  tasks       Task[]

  @@index([projectId], map: "idx_boards_project_id")
  @@index([teamId], map: "idx_boards_team_id")
  @@index([teamId, position], map: "idx_boards_team_position")
  @@map("boards")
}

model BoardList {
  id        String   @id @default(cuid())
  name      String
  boardId   String   @map("board_id")
  position  Int
  color     String?
  archived  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([boardId], map: "idx_board_lists_board_id")
  @@index([boardId, position], map: "idx_board_lists_position")
  @@map("board_lists")
}

model Task {
  id             String           @id @default(cuid())
  title          String
  boardId        String           @map("board_id")
  listId         String           @map("list_id")
  assignedTo     String?          @map("assigned_to")
  createdBy      String           @map("created_by")
  priority       TaskPriority     @default(MEDIUM)
  status         TaskStatus       @default(TODO)
  position       Int
  dueDate        DateTime?        @map("due_date")
  completedAt    DateTime?        @map("completed_at")
  estimatedHours Int?             @map("estimated_hours")
  actualHours    Int?             @map("actual_hours")
  tags           String[]
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  archived       Boolean          @default(false)
  description    String
  issues         Issue[]          @relation("TaskIssues")
  activities     TaskActivity[]
  attachments    TaskAttachment[]
  comments       TaskComment[]
  assignee       User?            @relation("TaskAssignee", fields: [assignedTo], references: [id])
  board          Board            @relation(fields: [boardId], references: [id], onDelete: Cascade)
  creator        User             @relation("TaskCreator", fields: [createdBy], references: [id])
  list           BoardList        @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([assignedTo], map: "idx_tasks_assigned_to")
  @@index([assignedTo, status, dueDate], map: "idx_tasks_assignee_status")
  @@index([boardId], map: "idx_tasks_board_id")
  @@index([boardId, listId, position], map: "idx_tasks_board_list_position")
  @@index([listId], map: "idx_tasks_list_id")
  @@index([priority], map: "idx_tasks_priority")
  @@index([status], map: "idx_tasks_status")
  @@map("tasks")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskCommentAuthor", fields: [userId], references: [id])

  @@map("task_comments")
}

model TaskAttachment {
  id         String   @id @default(cuid())
  taskId     String   @map("task_id")
  fileName   String   @map("file_name")
  fileUrl    String   @map("file_url")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  uploadedBy String   @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploader   User     @relation("TaskAttachmentUploader", fields: [uploadedBy], references: [id])

  @@map("task_attachments")
}

model BoardActivity {
  id        String   @id @default(cuid())
  boardId   String   @map("board_id")
  userId    String   @map("user_id")
  action    String
  details   Json
  createdAt DateTime @default(now()) @map("created_at")
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user      User     @relation("BoardActivityUser", fields: [userId], references: [id])

  @@map("board_activities")
}

model TaskActivity {
  id        String   @id @default(cuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  action    String
  details   Json
  createdAt DateTime @default(now()) @map("created_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskActivityUser", fields: [userId], references: [id])

  @@map("task_activities")
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  clientId    String?       @map("client_id")
  teamId      String        @map("team_id")
  startDate   DateTime?
  endDate     DateTime?
  status      ProjectStatus @default(PLANNING)
  goal        Int?          // Total number of tasks (goal)
  completedTasks Int?       // Number of completed tasks
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  boards      Board[]       @relation("ProjectBoards")
  issues      Issue[]
  client      Client?       @relation("ClientProjects", fields: [clientId], references: [id])
  team        Team          @relation("TeamProjects", fields: [teamId], references: [id])
  proposals   Proposal[]    @relation("ProjectProposals")
  estimations Estimation[]  @relation("ProjectEstimations")
  updates     UpdateDraft[] @relation("ProjectUpdates")
  scopeRadar  ScopeRadar[]  @relation("ProjectScopeRadar")

  @@index([clientId], map: "idx_projects_client_id")
  @@index([status], map: "idx_projects_status")
  @@index([teamId], map: "idx_projects_team_id")
  @@index([teamId, status, createdAt(sort: Desc)], map: "idx_projects_team_status")
  @@map("projects")
}

model Issue {
  id          String         @id @default(cuid())
  title       String
  description String
  status      IssueStatus    @default(OPEN)
  priority    IssuePriority  @default(MEDIUM)
  projectId   String?        @map("project_id")
  boardId     String?        @map("board_id")
  taskId      String?        @map("task_id")
  assignedTo  String?        @map("assigned_to")
  createdBy   String         @map("created_by")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  comments    IssueComment[]
  assignee    User?          @relation("IssueAssignee", fields: [assignedTo], references: [id])
  board       Board?         @relation("BoardIssues", fields: [boardId], references: [id])
  creator     User           @relation("IssueCreator", fields: [createdBy], references: [id])
  project     Project?       @relation(fields: [projectId], references: [id])
  task        Task?          @relation("TaskIssues", fields: [taskId], references: [id])

  @@index([assignedTo], map: "idx_issues_assigned_to")
  @@index([assignedTo, status, priority], map: "idx_issues_assignee_status")
  @@index([boardId], map: "idx_issues_board_id")
  @@index([createdBy], map: "idx_issues_created_by")
  @@index([priority], map: "idx_issues_priority")
  @@index([projectId], map: "idx_issues_project_id")
  @@index([status], map: "idx_issues_status")
  @@map("issues")
}

model IssueComment {
  id        String   @id @default(cuid())
  issueId   String   @map("issue_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user      User     @relation("IssueCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)

  @@map("issue_comments")
}

model PaymentSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  
  // Razorpay Route (Linked Account) - New Model
  razorpayAccountId   String?  @unique @map("razorpay_account_id") // Razorpay linked account ID
  accountStatus       AccountStatus @default(PENDING) @map("account_status") // pending, active, suspended, needs_clarification
  
  // Bank Account Details (Required for Razorpay Route)
  accountHolderName   String?  @map("account_holder_name")
  accountNumber       String?  @map("account_number")
  ifscCode            String?  @map("ifsc_code")
  bankName            String?  @map("bank_name")
  branchName          String?  @map("branch_name")
  accountType         AccountType? @map("account_type") // SAVINGS or CURRENT
  
  // KYC Details (Required by Razorpay Route)
  panNumber           String?  @map("pan_number")
  businessName        String?  @map("business_name")
  gstNumber           String?  @map("gst_number")
  
  // Contact Details
  contactEmail        String?  @map("contact_email")
  contactPhone        String?  @map("contact_phone")
  
  // Address (Required for KYC)
  businessAddress     String?  @map("business_address")
  city                String?
  state               String?
  pincode             String?
  country             String?  @default("India")
  
  // Platform Commission Settings
  enableCommission    Boolean  @default(true) @map("enable_commission") // Platform can charge commission
  commissionPercent   Float?   @default(5.0) @map("commission_percent") // Default 5%
  
  // Settlement Configuration
  settlementSchedule  SettlementSchedule @default(INSTANT) @map("settlement_schedule")
  
  // Status & Metadata
  accountActive       Boolean  @default(false) @map("account_active") // Is account ready for payments
  verificationNotes   String?  @map("verification_notes") // Notes from Razorpay verification
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  user                User     @relation("UserPaymentSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_payment_settings_user_id")
  @@index([razorpayAccountId], map: "idx_payment_settings_razorpay_account")
  @@index([accountStatus], map: "idx_payment_settings_status")
  @@map("payment_settings")
}

enum BoardType {
  KANBAN
  SCRUM
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  UPI
  BANK_TRANSFER
  CASH
  CARD
}

enum InvoiceRecurrence {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  PROSPECT
}

// Razorpay Route Enums
enum AccountStatus {
  PENDING           // Account creation initiated, awaiting verification
  ACTIVE            // Account verified and active
  SUSPENDED         // Account suspended by Razorpay
  NEEDS_CLARIFICATION // Additional info required
}

enum AccountType {
  SAVINGS
  CURRENT
}

enum SettlementSchedule {
  INSTANT           // Immediate transfer after payment
  DAILY             // Daily settlement
  WEEKLY            // Weekly settlement
  MONTHLY           // Monthly settlement
}

// AI Features Models

model Proposal {
  id              String         @id @default(cuid())
  clientId        String         @map("client_id")
  projectId       String?        @map("project_id")
  title           String
  brief           String         // Client brief/requirements
  deliverables    Json           // Array of deliverables with descriptions
  timeline        Json           // Timeline breakdown
  pricing         Float
  currency        String         @default("INR")
  paymentTerms    String?        @map("payment_terms")
  status          ProposalStatus @default(DRAFT)
  
  // Change Order Support
  isChangeOrder   Boolean        @default(false) @map("is_change_order")
  parentProposalId String?       @map("parent_proposal_id")
  changeReason    String?        @map("change_reason")
  
  // PDF & E-Signature
  pdfUrl          String?        @map("pdf_url")
  eSignatureUrl   String?        @map("e_signature_url")
  signedAt        DateTime?      @map("signed_at")
  signedByName    String?        @map("signed_by_name")
  
  // Email Tracking
  sentAt          DateTime?      @map("sent_at")
  sentTo          String?        @map("sent_to")
  
  // Acceptance Tracking
  acceptedAt      DateTime?      @map("accepted_at")
  rejectedAt      DateTime?      @map("rejected_at")
  
  // Expiration & Template
  expiresAt       DateTime?      @map("expires_at")
  sectionBlocks   Json?          @map("section_blocks") // Structured sections
  templateId      String?        @map("template_id")
  
  // AI Metadata
  generatedByAI   Boolean        @default(true) @map("generated_by_ai")
  aiPrompt        String?        @map("ai_prompt")
  aiModel         String?        @map("ai_model")
  
  createdBy       String         @map("created_by")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  
  client          Client         @relation("ClientProposals", fields: [clientId], references: [id], onDelete: Cascade)
  project         Project?       @relation("ProjectProposals", fields: [projectId], references: [id])
  signatures      Signature[]    @relation("ProposalSignatures")
  
  @@index([clientId], map: "idx_proposals_client_id")
  @@index([projectId], map: "idx_proposals_project_id")
  @@index([status], map: "idx_proposals_status")
  @@index([createdAt(sort: Desc)], map: "idx_proposals_created_at")
  @@map("proposals")
}

model Estimation {
  id                  String   @id @default(cuid())
  clientId            String?  @map("client_id")
  projectId           String?  @map("project_id")
  title               String
  description         String?
  
  // Estimation Results
  estimatedHours      Float    @map("estimated_hours")
  estimatedCost       Float    @map("estimated_cost")
  currency            String   @default("INR")
  confidence          Float?   // 0-1 confidence score
  
  // AI Analysis
  rationale           String   // AI's reasoning for the estimate
  suggestedPackages   Json?    @map("suggested_packages") // Array of package options
  riskFactors         Json?    @map("risk_factors") // Identified risks
  assumptions         Json?    // Assumptions made
  
  // Historical Data Used
  similarProjectsCount Int?    @default(0) @map("similar_projects_count")
  historicalAccuracy   Float?  @map("historical_accuracy")
  
  // AI Metadata
  aiModel             String?  @map("ai_model")
  
  createdBy           String   @map("created_by")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  client              Client?  @relation("ClientEstimations", fields: [clientId], references: [id], onDelete: Cascade)
  project             Project? @relation("ProjectEstimations", fields: [projectId], references: [id])
  
  @@index([clientId], map: "idx_estimations_client_id")
  @@index([projectId], map: "idx_estimations_project_id")
  @@index([createdAt(sort: Desc)], map: "idx_estimations_created_at")
  @@map("estimations")
}

model UpdateDraft {
  id              String       @id @default(cuid())
  weekStart       DateTime     @map("week_start") // Start of the week
  clientId        String       @map("client_id")
  projectId       String?      @map("project_id")
  
  // Update Content
  summary         String       // AI-generated summary
  accomplishments Json         // Array of accomplishments with details
  blockers        Json?        // Current blockers
  nextSteps       Json         @map("next_steps") // Planned next steps
  metrics         Json?        // Progress metrics (tasks completed, hours, etc.)
  
  // Status
  status          UpdateStatus @default(DRAFT)
  sentAt          DateTime?    @map("sent_at")
  sentTo          String?      @map("sent_to") // Email sent to
  
  // AI Metadata
  generatedByAI   Boolean      @default(true) @map("generated_by_ai")
  aiModel         String?      @map("ai_model")
  
  createdBy       String       @map("created_by")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  
  client          Client       @relation("ClientUpdates", fields: [clientId], references: [id], onDelete: Cascade)
  project         Project?     @relation("ProjectUpdates", fields: [projectId], references: [id])
  
  @@index([clientId], map: "idx_updates_client_id")
  @@index([projectId], map: "idx_updates_project_id")
  @@index([weekStart], map: "idx_updates_week_start")
  @@index([status], map: "idx_updates_status")
  @@map("update_drafts")
}

model ScopeRadar {
  id                String    @id @default(cuid())
  projectId         String    @map("project_id")
  
  // Scope Creep Analysis
  creepRisk         Float     @map("creep_risk") // 0-1 risk score
  revisionCount     Int       @default(0) @map("revision_count")
  outOfScopeCount   Int       @default(0) @map("out_of_scope_count")
  
  // Detection Details
  flaggedItems      Json      @map("flagged_items") // Items detected as scope creep
  patterns          Json?     // Detected patterns
  recommendations   Json?     // AI recommendations
  
  // Change Order Draft
  changeOrderDraft  String?   @map("change_order_draft") // AI-drafted change order email
  estimatedImpact   Json?     @map("estimated_impact") // Time/cost impact
  
  // Status
  acknowledged      Boolean   @default(false)
  acknowledgedAt    DateTime? @map("acknowledged_at")
  
  // AI Metadata
  aiModel           String?   @map("ai_model")
  
  flaggedAt         DateTime  @default(now()) @map("flagged_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  project           Project   @relation("ProjectScopeRadar", fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId], map: "idx_scope_radar_project_id")
  @@index([creepRisk], map: "idx_scope_radar_risk")
  @@index([flaggedAt(sort: Desc)], map: "idx_scope_radar_flagged_at")
  @@map("scope_radar")
}

model Signature {
  id            String    @id @default(cuid())
  proposalId    String    @map("proposal_id")
  
  // Signer Information
  signerName    String    @map("signer_name")
  signerEmail   String    @map("signer_email")
  signerTitle   String?   @map("signer_title") // Job title
  
  // Signature Data
  signatureBlob String    @map("signature_blob") @db.Text // Base64 encoded signature image
  signatureType String    @default("draw") @map("signature_type") // "draw" or "type"
  
  // Metadata
  signedAt      DateTime  @default(now()) @map("signed_at")
  ipAddress     String?   @map("ip_address")
  userAgent     String?   @map("user_agent")
  
  proposal      Proposal  @relation("ProposalSignatures", fields: [proposalId], references: [id], onDelete: Cascade)
  
  @@index([proposalId], map: "idx_signatures_proposal_id")
  @@index([signedAt(sort: Desc)], map: "idx_signatures_signed_at")
  @@map("signatures")
}

// AI Enums

enum ProposalStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  CONVERTED_TO_INVOICE
}

enum UpdateStatus {
  DRAFT
  SCHEDULED
  SENT
  DELIVERED
}
