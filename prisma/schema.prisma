generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "linux-musl"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String           @id
  email            String           @unique
  displayName      String?          @map("display_name")
  avatarUrl        String?          @map("avatar_url")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  stripeCustomerId String?          @unique @map("stripe_customer_id")
  activities       Activity[]
  boardActivities  BoardActivity[]  @relation("BoardActivityUser")
  clientsCreated   Client[]         @relation("UserClients")
  issuedInvoices   Invoice[]        @relation("IssuedBy")
  issueComments    IssueComment[]   @relation("IssueCommentAuthor")
  assignedIssues   Issue[]          @relation("IssueAssignee")
  createdIssues    Issue[]          @relation("IssueCreator")
  notifications    Notification[]   @relation("UserNotifications")
  organisations    Organisation[]   @relation("UserOrganisations")
  paymentSettings  PaymentSettings? @relation("UserPaymentSettings")
  subscription     Subscription?    @relation("UserSubscription")
  razorpayCustomer RazorpayCustomer?
  razorpaySubscriptions RazorpaySubscription[]
  razorpayPayments  RazorpayPayment[]
  usageRecords      UsageRecord[]
  taskActivities   TaskActivity[]   @relation("TaskActivityUser")
  taskAttachments  TaskAttachment[] @relation("TaskAttachmentUploader")
  taskComments     TaskComment[]    @relation("TaskCommentAuthor")
  assignedTasks    Task[]           @relation("TaskAssignee")
  createdTasks     Task[]           @relation("TaskCreator")
  invites          TeamInvite[]     @relation("InvitedBy")
  teamMembers      TeamMember[]
  ownedTeams       Team[]           @relation("TeamOwner")

  @@index([createdAt(sort: Desc)], map: "idx_users_created_at_desc")
  @@index([email], map: "idx_users_email")
  @@map("users")
}

model Subscription {
  id               String   @id @default(cuid())
  userId           String   @unique @map("user_id")
  stripePriceId    String   @map("stripe_price_id")
  stripeSubId      String   @map("stripe_subscription_id")
  currentPeriodEnd DateTime @map("current_period_end")
  status           String
  createdAt        DateTime @default(now()) @map("created_at")
  user             User     @relation("UserSubscription", fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Client {
  id             String        @id @default(cuid())
  name           String
  email          String
  phone          String?
  company        String?
  address        String?
  notes          String?
  budget         Float?
  currency       String?
  status         ClientStatus  @default(PROSPECT)
  createdBy      String        @map("created_by")
  organisationId String?       @map("organisation_id")
  createdAt      DateTime      @default(now()) @map("created_at")
  createdByUser  User          @relation("UserClients", fields: [createdBy], references: [id], onDelete: Cascade)
  organisation   Organisation? @relation("OrganisationClients", fields: [organisationId], references: [id], onDelete: Cascade)
  estimations    Estimation[]  @relation("ClientEstimations")
  invoices       Invoice[]
  projects       Project[]     @relation("ClientProjects")
  proposals      Proposal[]    @relation("ClientProposals")
  updates        UpdateDraft[] @relation("ClientUpdates")

  @@index([createdAt(sort: Desc)], map: "idx_clients_created_at_desc")
  @@index([createdBy], map: "idx_clients_created_by")
  @@index([organisationId], map: "idx_clients_organisation_id")
  @@index([organisationId, status, createdAt(sort: Desc)], map: "idx_clients_org_status_created")
  @@map("clients")
}

model Organisation {
  id          String             @id @default(cuid())
  name        String
  email       String
  phone       String?
  budget      Float?
  currency    String?            @default("INR")
  status      OrganisationStatus @default(ACTIVE)
  type        OrganisationType   @default(OWNER)
  notes       String?
  logoUrl     String?            @map("logo_url")
  website     String?
  address     String?
  city        String?
  state       String?
  country     String?            @default("India")
  pincode     String?
  ownerId     String             @map("owner_id")
  maxProjects Int                @default(5) @map("max_projects")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  owner       User               @relation("UserOrganisations", fields: [ownerId], references: [id], onDelete: Cascade)
  projects    Project[]          @relation("OrganisationProjects")
  teams       Team[]             @relation("OrganisationTeams")
  boards      Board[]            @relation("OrganisationBoards")
  clients     Client[]           @relation("OrganisationClients")
  invoices    Invoice[]          @relation("OrganisationInvoices")
  proposals   Proposal[]         @relation("OrganisationProposals")
  issues      Issue[]            @relation("OrganisationIssues")

  @@index([ownerId], map: "idx_organisations_owner_id")
  @@index([type], map: "idx_organisations_type")
  @@index([status], map: "idx_organisations_status")
  @@index([ownerId, type], map: "idx_organisations_owner_type")
  @@index([createdAt(sort: Desc)], map: "idx_organisations_created_at_desc")
  @@map("organisations")
}

model Invoice {
  id                        String             @id @default(cuid())
  invoiceNumber             String             @unique
  clientId                  String             @map("client_id")
  issuedById                String             @map("issued_by_id")
  organisationId            String?            @map("organisation_id")
  dueDate                   DateTime           @map("due_date")
  issuedDate                DateTime           @default(now()) @map("issued_date")
  status                    InvoiceStatus      @default(PENDING)
  paymentMethod             PaymentMethod?
  notes                     String?
  taxRate                   Float?             @map("tax_rate")
  discount                  Float?             @default(0)
  currency                  String             @default("INR")
  pdfUrl                    String?            @map("pdf_url")
  isRecurring               Boolean            @default(false) @map("is_recurring")
  recurrence                InvoiceRecurrence?
  nextIssueDate             DateTime?          @map("next_issue_date")
  lastSentDate              DateTime?          @map("last_sent_date")
  reminderSent              Boolean            @default(false) @map("reminder_sent")
  createdAt                 DateTime           @default(now()) @map("created_at")
  updatedAt                 DateTime           @updatedAt @map("updated_at")
  enablePaymentLink         Boolean            @default(false) @map("enable_payment_link")
  eSignatureUrl             String?            @map("e_signature_url")
  watermarkText             String?            @map("watermark_text")
  razorpayPaymentLinkId     String?            @map("razorpay_payment_link_id")
  razorpayPaymentLinkUrl    String?            @map("razorpay_payment_link_url")
  razorpayPaymentLinkStatus String?            @map("razorpay_payment_link_status")
  razorpayPaymentId         String?            @map("razorpay_payment_id")
  razorpayOrderId           String?            @map("razorpay_order_id")
  autoGenerateEnabled       Boolean            @default(true) @map("auto_generate_enabled")
  autoSendEnabled           Boolean            @default(false) @map("auto_send_enabled")
  maxOccurrences            Int?               @map("max_occurrences")
  occurrenceCount           Int                @default(0) @map("occurrence_count")
  parentInvoiceId           String?            @map("parent_invoice_id")
  recipientEmails           String[]           @default([]) @map("recipient_emails")
  sendDayOfPeriod           Int?               @map("send_day_of_period")
  items                     InvoiceItem[]
  client                    Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  issuedBy                  User               @relation("IssuedBy", fields: [issuedById], references: [id])
  organisation              Organisation?      @relation("OrganisationInvoices", fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([clientId], map: "idx_invoices_client_id")
  @@index([clientId, status, dueDate], map: "idx_invoices_client_status")
  @@index([dueDate], map: "idx_invoices_due_date")
  @@index([issuedById], map: "idx_invoices_issued_by_id")
  @@index([issuedDate], map: "idx_invoices_issued_date")
  @@index([status], map: "idx_invoices_status")
  @@index([issuedById, status, issuedDate(sort: Desc)], map: "idx_invoices_user_status")
  @@index([razorpayPaymentLinkId], map: "idx_invoices_razorpay_link_id")
  @@index([isRecurring, nextIssueDate], map: "idx_invoices_recurring_next")
  @@index([parentInvoiceId], map: "idx_invoices_parent_id")
  @@index([organisationId], map: "idx_invoices_organisation_id")
  @@index([organisationId, status, issuedDate(sort: Desc)], map: "idx_invoices_org_status_date")
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String   @map("invoice_id")
  description String
  quantity    Int
  rate        Float
  total       Float    @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId], map: "idx_invoice_items_invoice_id")
  @@map("invoice_items")
}

model Team {
  id             String       @id @default(cuid())
  name           String
  description    String?
  createdBy      String       @map("created_by")
  organisationId String?      @map("organisation_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  activities     Activity[]
  boards         Board[]
  projects       Project[]    @relation("TeamProjects")
  invites        TeamInvite[]
  members        TeamMember[]
  owner          User         @relation("TeamOwner", fields: [createdBy], references: [id], onDelete: Cascade)
  organisation   Organisation? @relation("OrganisationTeams", fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)], map: "idx_teams_created_at_desc")
  @@index([createdBy], map: "idx_teams_created_by")
  @@index([organisationId], map: "idx_teams_organisation_id")
  @@map("teams")
}

model TeamMember {
  id         String   @id @default(cuid())
  teamId     String   @map("team_id")
  userId     String   @map("user_id")
  role       String   @default("member")
  addedBy    String   @map("added_by")
  acceptedAt DateTime @default(now()) @map("accepted_at")
  createdAt  DateTime @default(now()) @map("created_at")
  team       Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId, role], map: "idx_team_members_role")
  @@index([teamId], map: "idx_team_members_team_id")
  @@index([userId], map: "idx_team_members_user_id")
  @@map("team_members")
}

model TeamInvite {
  id        String    @id @default(cuid())
  teamId    String    @map("team_id")
  email     String
  role      String    @default("member")
  token     String    @unique
  invitedBy String    @map("invited_by")
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  inviter   User      @relation("InvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email])
  @@index([email], map: "idx_team_invites_email")
  @@index([teamId], map: "idx_team_invites_team_id")
  @@index([token], map: "idx_team_invites_token")
  @@map("team_invites")
}

model Activity {
  id            String         @id @default(cuid())
  teamId        String         @map("team_id")
  userId        String         @map("user_id")
  type          String
  title         String
  details       Json?
  createdAt     DateTime       @default(now()) @map("created_at")
  team          Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([createdAt(sort: Desc)], map: "idx_activities_created_at")
  @@index([userId], map: "idx_activities_user_id")
  @@index([userId, createdAt(sort: Desc)], map: "idx_activities_user_recent")
  @@map("activities")
}

model Notification {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  activityId String    @map("activity_id")
  readAt     DateTime? @map("read_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  activity   Activity  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user       User      @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, activityId])
  @@index([userId, readAt])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

model Board {
  id             String          @id @default(cuid())
  name           String
  type           BoardType       @default(KANBAN)
  teamId         String          @map("team_id")
  createdBy      String          @map("created_by")
  organisationId String?         @map("organisation_id")
  settings       Json?
  position       Int             @default(0)
  archived       Boolean         @default(false)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  projectId      String?         @map("project_id")
  description    String?
  activities     BoardActivity[]
  lists          BoardList[]
  project        Project?        @relation("ProjectBoards", fields: [projectId], references: [id])
  team           Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  organisation   Organisation?   @relation("OrganisationBoards", fields: [organisationId], references: [id], onDelete: Cascade)
  issues         Issue[]         @relation("BoardIssues")
  tasks          Task[]

  @@index([projectId], map: "idx_boards_project_id")
  @@index([teamId], map: "idx_boards_team_id")
  @@index([teamId, position], map: "idx_boards_team_position")
  @@index([organisationId], map: "idx_boards_organisation_id")
  @@index([organisationId, teamId], map: "idx_boards_org_team")
  @@map("boards")
}

model BoardList {
  id        String   @id @default(cuid())
  name      String
  boardId   String   @map("board_id")
  position  Int
  color     String?
  archived  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([boardId], map: "idx_board_lists_board_id")
  @@index([boardId, position], map: "idx_board_lists_position")
  @@map("board_lists")
}

model Task {
  id             String           @id @default(cuid())
  title          String
  boardId        String           @map("board_id")
  listId         String           @map("list_id")
  assignedTo     String?          @map("assigned_to")
  createdBy      String           @map("created_by")
  priority       TaskPriority     @default(MEDIUM)
  status         TaskStatus       @default(TODO)
  position       Int
  dueDate        DateTime?        @map("due_date")
  completedAt    DateTime?        @map("completed_at")
  estimatedHours Int?             @map("estimated_hours")
  actualHours    Int?             @map("actual_hours")
  tags           String[]
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  archived       Boolean          @default(false)
  description    String
  issues         Issue[]          @relation("TaskIssues")
  activities     TaskActivity[]
  attachments    TaskAttachment[]
  comments       TaskComment[]
  assignee       User?            @relation("TaskAssignee", fields: [assignedTo], references: [id])
  board          Board            @relation(fields: [boardId], references: [id], onDelete: Cascade)
  creator        User             @relation("TaskCreator", fields: [createdBy], references: [id])
  list           BoardList        @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([assignedTo], map: "idx_tasks_assigned_to")
  @@index([assignedTo, status, dueDate], map: "idx_tasks_assignee_status")
  @@index([boardId], map: "idx_tasks_board_id")
  @@index([boardId, listId, position], map: "idx_tasks_board_list_position")
  @@index([listId], map: "idx_tasks_list_id")
  @@index([priority], map: "idx_tasks_priority")
  @@index([status], map: "idx_tasks_status")
  @@map("tasks")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskCommentAuthor", fields: [userId], references: [id])

  @@map("task_comments")
}

model TaskAttachment {
  id         String   @id @default(cuid())
  taskId     String   @map("task_id")
  fileName   String   @map("file_name")
  fileUrl    String   @map("file_url")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  uploadedBy String   @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploader   User     @relation("TaskAttachmentUploader", fields: [uploadedBy], references: [id])

  @@map("task_attachments")
}

model BoardActivity {
  id        String   @id @default(cuid())
  boardId   String   @map("board_id")
  userId    String   @map("user_id")
  action    String
  details   Json
  createdAt DateTime @default(now()) @map("created_at")
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user      User     @relation("BoardActivityUser", fields: [userId], references: [id])

  @@map("board_activities")
}

model TaskActivity {
  id        String   @id @default(cuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  action    String
  details   Json
  createdAt DateTime @default(now()) @map("created_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskActivityUser", fields: [userId], references: [id])

  @@map("task_activities")
}

model Project {
  id             String        @id @default(cuid())
  name           String
  description    String?
  clientId       String?       @map("client_id")
  teamId         String        @map("team_id")
  status         ProjectStatus @default(PLANNING)
  goal           Int?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  completedTasks Int?          @map("completed_tasks")
  endDate        DateTime?     @map("end_date")
  organisationId String?       @map("organisation_id")
  startDate      DateTime?     @map("start_date")
  boards         Board[]       @relation("ProjectBoards")
  estimations    Estimation[]  @relation("ProjectEstimations")
  issues         Issue[]
  client         Client?       @relation("ClientProjects", fields: [clientId], references: [id])
  organisation   Organisation? @relation("OrganisationProjects", fields: [organisationId], references: [id], onDelete: Cascade)
  team           Team          @relation("TeamProjects", fields: [teamId], references: [id])
  proposals      Proposal[]    @relation("ProjectProposals")
  scopeRadar     ScopeRadar[]  @relation("ProjectScopeRadar")
  updates        UpdateDraft[] @relation("ProjectUpdates")

  @@index([clientId], map: "idx_projects_client_id")
  @@index([organisationId], map: "idx_projects_organisation_id")
  @@index([status], map: "idx_projects_status")
  @@index([teamId], map: "idx_projects_team_id")
  @@index([teamId, status, createdAt(sort: Desc)], map: "idx_projects_team_status")
  @@index([organisationId, status], map: "idx_projects_org_status")
  @@map("projects")
}

model Issue {
  id             String         @id @default(cuid())
  title          String
  description    String
  status         IssueStatus    @default(OPEN)
  priority       IssuePriority  @default(MEDIUM)
  projectId      String?        @map("project_id")
  boardId        String?        @map("board_id")
  taskId         String?        @map("task_id")
  assignedTo     String?        @map("assigned_to")
  createdBy      String         @map("created_by")
  organisationId String?        @map("organisation_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  comments       IssueComment[]
  assignee       User?          @relation("IssueAssignee", fields: [assignedTo], references: [id])
  board          Board?         @relation("BoardIssues", fields: [boardId], references: [id])
  creator        User           @relation("IssueCreator", fields: [createdBy], references: [id])
  project        Project?       @relation(fields: [projectId], references: [id])
  task           Task?          @relation("TaskIssues", fields: [taskId], references: [id])
  organisation   Organisation?  @relation("OrganisationIssues", fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([assignedTo], map: "idx_issues_assigned_to")
  @@index([assignedTo, status, priority], map: "idx_issues_assignee_status")
  @@index([boardId], map: "idx_issues_board_id")
  @@index([createdBy], map: "idx_issues_created_by")
  @@index([priority], map: "idx_issues_priority")
  @@index([projectId], map: "idx_issues_project_id")
  @@index([status], map: "idx_issues_status")
  @@index([organisationId], map: "idx_issues_organisation_id")
  @@index([organisationId, status, priority], map: "idx_issues_org_status_priority")
  @@map("issues")
}

model IssueComment {
  id        String   @id @default(cuid())
  issueId   String   @map("issue_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user      User     @relation("IssueCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)

  @@map("issue_comments")
}

model PaymentSettings {
  id                 String             @id @default(cuid())
  userId             String             @unique @map("user_id")
  razorpayAccountId  String?            @unique @map("razorpay_account_id")
  accountStatus      AccountStatus      @default(PENDING) @map("account_status")
  accountHolderName  String?            @map("account_holder_name")
  accountNumber      String?            @map("account_number")
  ifscCode           String?            @map("ifsc_code")
  bankName           String?            @map("bank_name")
  branchName         String?            @map("branch_name")
  accountType        AccountType?       @map("account_type")
  panNumber          String?            @map("pan_number")
  businessName       String?            @map("business_name")
  gstNumber          String?            @map("gst_number")
  contactEmail       String?            @map("contact_email")
  contactPhone       String?            @map("contact_phone")
  businessAddress    String?            @map("business_address")
  city               String?
  state              String?
  pincode            String?
  country            String?            @default("India")
  enableCommission   Boolean            @default(true) @map("enable_commission")
  commissionPercent  Float?             @default(5.0) @map("commission_percent")
  settlementSchedule SettlementSchedule @default(INSTANT) @map("settlement_schedule")
  accountActive      Boolean            @default(false) @map("account_active")
  verificationNotes  String?            @map("verification_notes")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  user               User               @relation("UserPaymentSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_payment_settings_user_id")
  @@index([razorpayAccountId], map: "idx_payment_settings_razorpay_account")
  @@index([accountStatus], map: "idx_payment_settings_status")
  @@map("payment_settings")
}

model Proposal {
  id               String         @id @default(cuid())
  clientId         String         @map("client_id")
  projectId        String?        @map("project_id")
  organisationId   String?        @map("organisation_id")
  title            String
  brief            String
  deliverables     Json
  timeline         Json
  pricing          Float
  currency         String         @default("INR")
  paymentTerms     String?        @map("payment_terms")
  status           ProposalStatus @default(DRAFT)
  isChangeOrder    Boolean        @default(false) @map("is_change_order")
  parentProposalId String?        @map("parent_proposal_id")
  changeReason     String?        @map("change_reason")
  pdfUrl           String?        @map("pdf_url")
  eSignatureUrl    String?        @map("e_signature_url")
  signedAt         DateTime?      @map("signed_at")
  signedByName     String?        @map("signed_by_name")
  generatedByAI    Boolean        @default(true) @map("generated_by_ai")
  aiPrompt         String?        @map("ai_prompt")
  aiModel          String?        @map("ai_model")
  createdBy        String         @map("created_by")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  acceptedAt       DateTime?      @map("accepted_at")
  expiresAt        DateTime?      @map("expires_at")
  rejectedAt       DateTime?      @map("rejected_at")
  sectionBlocks    Json?          @map("section_blocks")
  sentAt           DateTime?      @map("sent_at")
  sentTo           String?        @map("sent_to")
  templateId       String?        @map("template_id")
  accessToken      String?        @unique @map("access_token")
  lastViewedAt     DateTime?      @map("last_viewed_at")
  tokenExpiresAt   DateTime?      @map("token_expires_at")
  viewCount        Int            @default(0) @map("view_count")
  client           Client         @relation("ClientProposals", fields: [clientId], references: [id], onDelete: Cascade)
  project          Project?       @relation("ProjectProposals", fields: [projectId], references: [id])
  organisation     Organisation?  @relation("OrganisationProposals", fields: [organisationId], references: [id], onDelete: Cascade)
  signatures       Signature[]    @relation("ProposalSignatures")

  @@index([clientId], map: "idx_proposals_client_id")
  @@index([projectId], map: "idx_proposals_project_id")
  @@index([status], map: "idx_proposals_status")
  @@index([createdAt(sort: Desc)], map: "idx_proposals_created_at")
  @@index([organisationId], map: "idx_proposals_organisation_id")
  @@index([organisationId, status, createdAt(sort: Desc)], map: "idx_proposals_org_status_created")
  @@map("proposals")
}

model Estimation {
  id                   String   @id @default(cuid())
  clientId             String?  @map("client_id")
  projectId            String?  @map("project_id")
  title                String
  description          String?
  estimatedHours       Float    @map("estimated_hours")
  estimatedCost        Float    @map("estimated_cost")
  currency             String   @default("INR")
  confidence           Float?
  rationale            String
  suggestedPackages    Json?    @map("suggested_packages")
  riskFactors          Json?    @map("risk_factors")
  assumptions          Json?
  similarProjectsCount Int?     @default(0) @map("similar_projects_count")
  historicalAccuracy   Float?   @map("historical_accuracy")
  aiModel              String?  @map("ai_model")
  createdBy            String   @map("created_by")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  client               Client?  @relation("ClientEstimations", fields: [clientId], references: [id], onDelete: Cascade)
  project              Project? @relation("ProjectEstimations", fields: [projectId], references: [id])

  @@index([clientId], map: "idx_estimations_client_id")
  @@index([projectId], map: "idx_estimations_project_id")
  @@index([createdAt(sort: Desc)], map: "idx_estimations_created_at")
  @@map("estimations")
}

model BudgetEstimation {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  title            String
  brief            String
  deliverables     Json
  timeline         Json
  estimatedBudget  Float    @map("estimated_budget")
  actualBudget     Float?   @map("actual_budget")
  confidence       String
  breakdown        Json
  rationale        String
  currency         String   @default("INR")
  deliverableCount Int      @map("deliverable_count")
  timelineWeeks    Float    @map("timeline_weeks")
  accuracy         Float?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([userId], map: "idx_budget_estimations_user_id")
  @@index([createdAt(sort: Desc)], map: "idx_budget_estimations_created_at")
  @@index([accuracy], map: "idx_budget_estimations_accuracy")
  @@map("budget_estimations")
}

model UpdateDraft {
  id              String       @id @default(cuid())
  weekStart       DateTime     @map("week_start")
  clientId        String       @map("client_id")
  projectId       String?      @map("project_id")
  summary         String
  accomplishments Json
  blockers        Json?
  nextSteps       Json         @map("next_steps")
  metrics         Json?
  status          UpdateStatus @default(DRAFT)
  sentAt          DateTime?    @map("sent_at")
  sentTo          String?      @map("sent_to")
  generatedByAI   Boolean      @default(true) @map("generated_by_ai")
  aiModel         String?      @map("ai_model")
  createdBy       String       @map("created_by")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  client          Client       @relation("ClientUpdates", fields: [clientId], references: [id], onDelete: Cascade)
  project         Project?     @relation("ProjectUpdates", fields: [projectId], references: [id])

  @@index([clientId], map: "idx_updates_client_id")
  @@index([projectId], map: "idx_updates_project_id")
  @@index([weekStart], map: "idx_updates_week_start")
  @@index([status], map: "idx_updates_status")
  @@map("update_drafts")
}

model ScopeRadar {
  id                   String    @id @default(cuid())
  projectId            String    @map("project_id")
  creepRisk            Float     @map("creep_risk")
  revisionCount        Int       @default(0) @map("revision_count")
  outOfScopeCount      Int       @default(0) @map("out_of_scope_count")
  flaggedItems         Json      @map("flagged_items")
  patterns             Json?
  recommendations      Json?
  changeOrderDraft     String?   @map("change_order_draft")
  estimatedImpact      Json?     @map("estimated_impact")
  acknowledged         Boolean   @default(false)
  acknowledgedAt       DateTime? @map("acknowledged_at")
  aiModel              String?   @map("ai_model")
  flaggedAt            DateTime  @default(now()) @map("flagged_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  budgetOverrun        Float?    @map("budget_overrun")
  budgetOverrunPercent Float?    @map("budget_overrun_percent")
  clientEmailDraft     String?   @map("client_email_draft")
  currentEstimate      Float?    @map("current_estimate")
  emailSent            Boolean   @default(false) @map("email_sent")
  emailSentAt          DateTime? @map("email_sent_at")
  originalBudget       Float?    @map("original_budget")
  project              Project   @relation("ProjectScopeRadar", fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId], map: "idx_scope_radar_project_id")
  @@index([creepRisk], map: "idx_scope_radar_risk")
  @@index([flaggedAt(sort: Desc)], map: "idx_scope_radar_flagged_at")
  @@index([budgetOverrun], map: "idx_scope_radar_budget_overrun")
  @@index([emailSent], map: "idx_scope_radar_email_sent")
  @@map("scope_radar")
}

model Signature {
  id            String   @id @default(cuid())
  proposalId    String   @map("proposal_id")
  signerName    String   @map("signer_name")
  signerEmail   String   @map("signer_email")
  signerTitle   String?  @map("signer_title")
  signatureBlob String   @map("signature_blob")
  signatureType String   @default("draw") @map("signature_type")
  signedAt      DateTime @default(now()) @map("signed_at")
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  proposal      Proposal @relation("ProposalSignatures", fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId], map: "idx_signatures_proposal_id")
  @@index([signedAt(sort: Desc)], map: "idx_signatures_signed_at")
  @@map("signatures")
}

enum BoardType {
  KANBAN
  SCRUM
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  UPI
  BANK_TRANSFER
  CASH
  CARD
}

enum InvoiceRecurrence {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  PROSPECT
}

enum AccountStatus {
  PENDING
  ACTIVE
  SUSPENDED
  NEEDS_CLARIFICATION
}

enum AccountType {
  SAVINGS
  CURRENT
}

enum SettlementSchedule {
  INSTANT
  DAILY
  WEEKLY
  MONTHLY
}

enum ProposalStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  CONVERTED_TO_INVOICE
}

enum UpdateStatus {
  DRAFT
  SCHEDULED
  SENT
  DELIVERED
}

enum OrganisationType {
  OWNER
  CLIENT
}

enum OrganisationStatus {
  PROSPECT
  ACTIVE
  INACTIVE
}

// Razorpay & Subscription models
model RazorpayCustomer {
  id                 String   @id @default(cuid())
  userId             String   @unique
  razorpayCustomerId String   @unique
  email              String
  name               String?
  phone              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions      RazorpaySubscription[]
  payments           RazorpayPayment[]

  @@index([userId])
  @@index([razorpayCustomerId])
}

model RazorpaySubscription {
  id                     String   @id @default(cuid())
  userId                 String
  customerId             String
  razorpaySubscriptionId String   @unique
  razorpayPlanId         String
  status                 SubscriptionStatus
  planTier               PlanTier
  quantity               Int      @default(1)

  currentPeriodStart     DateTime
  currentPeriodEnd       DateTime
  cancelAtPeriodEnd      Boolean  @default(false)
  canceledAt             DateTime?
  endedAt                DateTime?

  totalCount             Int?
  paidCount              Int      @default(0)
  remainingCount         Int?
  shortUrl               String?

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  customer               RazorpayCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user                   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageRecords           UsageRecord[]

  @@index([userId])
  @@index([customerId])
  @@index([razorpaySubscriptionId])
  @@index([status])
}

model RazorpayPayment {
  id                 String   @id @default(cuid())
  userId             String
  customerId         String
  razorpayPaymentId  String   @unique
  razorpayOrderId    String?

  amount             Int      // in paise
  currency           String   @default("INR")
  status             PaymentStatus
  method             String?
  description        String?
  email              String?
  contact            String?
  invoiceId          String?
  notes              Json?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  customer           RazorpayCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([customerId])
  @@index([razorpayPaymentId])
  @@index([status])
}

model SubscriptionPlan {
  id                   String   @id @default(cuid())
  razorpayPlanId       String   @unique
  name                 String
  tier                 PlanTier
  description          String?
  amount               Int      // monthly price in paise
  currency             String   @default("INR")
  period               String   @default("monthly")
  interval             Int      @default(1)
  maxOrganisations     Int
  maxProjects          Int
  maxTeamMembers       Int
  maxAIProposals       Int
  maxAIContracts       Int
  maxRecurringInvoices Int
  maxInvoices          Int
  maxStorage           BigInt
  scopeRadarLevel      String
  analyticsLevel       String
  supportLevel         String
  customBranding       Boolean  @default(false)
  apiAccess            Boolean  @default(false)
  whiteLabel           Boolean  @default(false)
  active               Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([tier])
  @@index([active])
}

model UsageRecord {
  id             String   @id @default(cuid())
  userId         String
  subscriptionId String
  featureType    FeatureType
  count          Int      @default(1)
  periodStart    DateTime
  periodEnd      DateTime
  createdAt      DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription   RazorpaySubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subscriptionId])
  @@index([featureType])
  @@index([periodStart])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  resource   String?
  resourceId String?
  meta       Json?
  createdAt  DateTime @default(now())
}

// AI-backed documents storage for embeddings & retrieval (pgvector column)
model Document {
  id        String   @id @default(cuid())
  namespace String?  
  title     String?  
  content   String?
  metadata  Json?
  // Embedding defined as an unsupported type; requires pgvector extension in Postgres
  embedding Unsupported("vector(384)")? 
  createdAt DateTime @default(now()) @map("created_at")

  @@map("documents")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
  PAUSED
}

enum PaymentStatus {
  CREATED
  AUTHORIZED
  CAPTURED
  REFUNDED
  FAILED
}

enum PlanTier {
  FREE
  STARTER
  GROWTH
  PROFESSIONAL
  ENTERPRISE
}

enum FeatureType {
  AI_PROPOSAL
  AI_CONTRACT
  RECURRING_INVOICE
  SCOPE_RADAR_CHECK
  INVOICE_GENERATED
  STORAGE_USED
  TEAM_MEMBER_ADDED
  PROJECT_CREATED
  ORGANISATION_CREATED
}
